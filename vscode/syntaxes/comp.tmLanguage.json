{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Comp",
  "patterns": [
    {
      "include": "#module-frontmatter"
    },
    {
      "include": "#comments"
    },
    {
      "include": "#keywords"
    },
    {
      "include": "#definitions"
    },
    {
      "include": "#strings"
    },
    {
      "include": "#numbers"
    },
    {
      "include": "#tags"
    },
    {
      "include": "#shapes"
    },
    {
      "include": "#scopes"
    },
    {
      "include": "#constants"
    },
    {
      "include": "#pipeline-operators"
    },
    {
      "include": "#operators"
    },
    {
      "include": "#named-field-assignment"
    },
    {
      "include": "#blocks"
    }
  ],
  "repository": {
    "module-frontmatter": {
      "comment": "Module-level documentation prose before ___",
      "name": "meta.frontmatter.comp",
      "begin": "\\A(?=\\s*[A-Za-z\\u00C0-\\u024F\\u0370-\\u03FF\\u0400-\\u04FF\\u4E00-\\u9FFF])",
      "end": "(___)",
      "endCaptures": {
        "1": {
          "name": "punctuation.definition.documentation.separator.comp"
        }
      },
      "contentName": "comment.block.documentation.comp"
    },
    "block-frontmatter": {
      "comment": "Documentation prose: a line of prose-like text that will be followed by ___",
      "patterns": [
        {
          "comment": "A line that looks like prose (starts with letter, no braces/parens/operators at start)",
          "name": "comment.block.documentation.comp",
          "match": "^\\s*[A-Za-z\\u00C0-\\u024F\\u0370-\\u03FF\\u0400-\\u04FF\\u4E00-\\u9FFF][^=|~:{}()\\[\\]#]*$"
        }
      ]
    },
    "keywords": {
      "patterns": [
        {
          "name": "keyword.other.directive.comp",
          "match": "![\\w.-]+"
        }
      ]
    },
    "comments": {
      "name": "comment.line.hash.comp",
      "match": "#\\s.*$"
    },
    "definitions": {
      "patterns": [
        {
          "name": "meta.definition.function.comp",
          "begin": "^\\s*(!entry\\s+)?(!pure\\s+)?(!func)\\s+([\\w.-]+(?:/[\\w.-]+)?)",
          "beginCaptures": {
            "1": {
              "name": "keyword.declaration.entry.comp"
            },
            "2": {
              "name": "keyword.declaration.pure.comp"
            },
            "3": {
              "name": "keyword.declaration.function.comp"
            },
            "4": {
              "name": "entity.name.function.definition.comp"
            }
          },
          "end": "(?<=\\})|(?<=\\))|$",
          "patterns": [
            {
              "include": "#shape-annotations"
            },
            {
              "include": "#shapes"
            },
            {
              "include": "#operators"
            },
            {
              "include": "$self"
            }
          ]
        },
        {
          "name": "meta.definition.shape.comp",
          "begin": "^\\s*([\\w.-]+)\\s*(=)\\s*(~)\\s*(?=[\\{\\(])",
          "beginCaptures": {
            "1": {
              "name": "entity.name.type.definition.comp"
            },
            "2": {
              "name": "keyword.operator.assignment.comp"
            },
            "3": {
              "name": "keyword.operator.shape.comp"
            }
          },
          "end": "(?<=\\})|(?<=\\))|$",
          "patterns": [
            {
              "include": "#shape-field-definitions"
            },
            {
              "include": "$self"
            }
          ]
        },
        {
          "name": "meta.definition.import.comp",
          "match": "^\\s*(import)\\.([\\w.-]+)\\s*(=)\\s*\\{",
          "captures": {
            "1": {
              "name": "keyword.declaration.import.comp"
            },
            "2": {
              "name": "entity.name.namespace.comp"
            },
            "3": {
              "name": "keyword.operator.assignment.comp"
            }
          }
        },
        {
          "name": "meta.definition.mod.comp",
          "match": "^\\s*(mod)\\.([\\w.-]+)\\s*(=)",
          "captures": {
            "1": {
              "name": "keyword.declaration.mod.comp"
            },
            "2": {
              "name": "variable.other.constant.comp"
            },
            "3": {
              "name": "keyword.operator.assignment.comp"
            }
          }
        },
        {
          "name": "meta.definition.context.comp",
          "match": "^\\s*(context)\\.([\\w.-]+)\\s*(=)",
          "captures": {
            "1": {
              "name": "keyword.declaration.context.comp"
            },
            "2": {
              "name": "entity.name.namespace.comp"
            },
            "3": {
              "name": "keyword.operator.assignment.comp"
            }
          }
        },
        {
          "name": "meta.definition.alias.comp",
          "match": "^\\s*(!alias)\\s+([\\w.-]+)\\s*(=)",
          "captures": {
            "1": {
              "name": "keyword.declaration.alias.comp"
            },
            "2": {
              "name": "entity.name.alias.comp"
            },
            "3": {
              "name": "keyword.operator.assignment.comp"
            }
          }
        }
      ]
    },
    "pipeline-operators": {
      "patterns": [
        {
          "name": "keyword.control.pipe.comp",
          "match": "\\|(?!\\||\\?)"
        },
        {
          "name": "keyword.control.pipe.fallback.comp",
          "match": "\\|\\?"
        }
      ]
    },
    "strings": {
      "patterns": [
        {
          "name": "string.quoted.triple.comp",
          "begin": "\"\"\"",
          "end": "\"\"\"",
          "patterns": [
            {
              "name": "meta.embedded.expression.comp",
              "begin": "\\$\\{",
              "end": "\\}",
              "patterns": [
                {
                  "include": "$self"
                }
              ]
            },
            {
              "name": "constant.character.escape.comp",
              "match": "\\\\."
            }
          ]
        },
        {
          "name": "string.quoted.double.comp",
          "begin": "\"",
          "end": "\"",
          "patterns": [
            {
              "name": "meta.embedded.expression.comp",
              "begin": "\\$\\{",
              "end": "\\}",
              "patterns": [
                {
                  "include": "$self"
                }
              ]
            },
            {
              "name": "constant.character.escape.comp",
              "match": "\\\\."
            }
          ]
        }
      ]
    },
    "numbers": {
      "patterns": [
        {
          "name": "constant.numeric.hex.comp",
          "match": "\\b0[xX][0-9a-fA-F_]+\\b"
        },
        {
          "name": "constant.numeric.binary.comp",
          "match": "\\b0[bB][01_]+\\b"
        },
        {
          "name": "constant.numeric.octal.comp",
          "match": "\\b0[oO][0-7_]+\\b"
        },
        {
          "name": "constant.numeric.float.comp",
          "match": "\\b\\d[\\d_]*\\.\\d[\\d_]*(?:[eE][+-]?\\d[\\d_]*)?\\b"
        },
        {
          "name": "constant.numeric.float.comp",
          "match": "\\b\\.\\d[\\d_]*(?:[eE][+-]?\\d[\\d_]*)?\\b"
        },
        {
          "name": "constant.numeric.float.comp",
          "match": "\\b\\d[\\d_]*[eE][+-]?\\d[\\d_]*\\b"
        },
        {
          "name": "constant.numeric.integer.comp",
          "match": "\\b\\d[\\d_]*\\b"
        }
      ]
    },
    "tags": {
      "patterns": [
        {
          "name": "entity.name.tag.indexed.comp",
          "match": "#\\d+"
        },
        {
          "name": "entity.name.tag.computed.comp",
          "begin": "#\\(",
          "end": "\\)",
          "patterns": [
            {
              "include": "$self"
            }
          ]
        },
        {
          "name": "entity.name.tag.comp",
          "match": "#[\\w.-]+(?:/[\\w.-]+)?"
        }
      ]
    },
    "shapes": {
      "patterns": [
        {
          "name": "storage.type.shape.builtin.comp",
          "match": "~(?:num|text|bool|nil|any)\\b"
        },
        {
          "name": "storage.type.shape.comp",
          "match": "~[\\w.-]+(?:/[\\w.-]+)?(?:\\[\\])?"
        },
        {
          "name": "meta.shape.inline.comp",
          "begin": "~\\{",
          "end": "\\}",
          "patterns": [
            {
              "include": "#shape-contents"
            }
          ]
        },
        {
          "name": "meta.shape.inline.comp",
          "begin": "~\\(",
          "end": "\\)",
          "patterns": [
            {
              "include": "#shape-contents"
            }
          ]
        }
      ]
    },
    "shape-annotations": {
      "patterns": [
        {
          "match": "([\\w.-]+)(\\?)?\\s*(~[\\w.-]+(?:/[\\w.-]+)?)",
          "captures": {
            "1": {
              "name": "variable.parameter.comp"
            },
            "2": {
              "name": "keyword.operator.optional.comp"
            },
            "3": {
              "name": "storage.type.shape.comp"
            }
          }
        }
      ]
    },
    "shape-field-definitions": {
      "patterns": [
        {
          "comment": "Field with shape annotation and optional default value: name~type = default",
          "match": "([\\w.-]+)(\\?)?\\s*(~[\\w.-]+(?:/[\\w.-]+)?(?:\\[\\])?)?\\s*(=)?",
          "captures": {
            "1": {
              "name": "variable.parameter.comp"
            },
            "2": {
              "name": "keyword.operator.optional.comp"
            },
            "3": {
              "name": "storage.type.shape.comp"
            },
            "4": {
              "name": "keyword.operator.assignment.comp"
            }
          }
        },
        {
          "name": "keyword.operator.spread.comp",
          "match": "\\.\\."
        }
      ]
    },
    "shape-contents": {
      "comment": "Contents inside shape definitions - fields with demoted pipe operator",
      "patterns": [
        {
          "include": "#comments"
        },
        {
          "include": "#strings"
        },
        {
          "include": "#numbers"
        },
        {
          "comment": "Pipe is demoted to regular operator inside shapes",
          "name": "keyword.operator.pipe.comp",
          "match": "\\|"
        },
        {
          "include": "#shape-field-definitions"
        },
        {
          "include": "#shapes"
        },
        {
          "include": "#operators"
        }
      ]
    },
    "scopes": {
      "patterns": [
        {
          "name": "variable.language.scope.comp",
          "match": "\\b(?:in|it|var|mod|context|pkg|import)\\b"
        }
      ]
    },
    "constants": {
      "patterns": [
        {
          "name": "constant.language.placeholder.comp",
          "match": "\\?\\?\\?"
        },
        {
          "name": "comment.block.documentation.separator.comp",
          "match": "___"
        }
      ]
    },
    "operators": {
      "patterns": [
        {
          "name": "keyword.operator.morph.strong.comp",
          "match": "~\\*"
        },
        {
          "name": "keyword.operator.morph.weak.comp",
          "match": "~\\?"
        },
        {
          "name": "keyword.operator.morph.comp",
          "match": "~"
        },
        {
          "name": "keyword.operator.assignment.strong.comp",
          "match": "=\\*"
        },
        {
          "name": "keyword.operator.assignment.weak.comp",
          "match": "=\\?"
        },
        {
          "name": "keyword.operator.spread-assignment.strong.comp",
          "match": "\\.\\.\\.?=\\*"
        },
        {
          "name": "keyword.operator.spread-assignment.weak.comp",
          "match": "\\.\\.\\.?=\\?"
        },
        {
          "name": "keyword.operator.spread-assignment.comp",
          "match": "\\.\\.\\.?="
        },
        {
          "name": "keyword.operator.comparison.comp",
          "match": "==|!="
        },
        {
          "name": "keyword.control.assignment.comp",
          "match": "="
        },
        {
          "name": "keyword.operator.logical.comp",
          "match": "&&|\\|\\||!!"
        },
        {
          "name": "keyword.operator.comparison.comp",
          "match": "<=|>=|<|>"
        },
        {
          "name": "keyword.operator.fallback.comp",
          "match": "\\?\\?"
        },
        {
          "name": "keyword.operator.spread.comp",
          "match": "\\.\\."
        },
        {
          "name": "keyword.operator.power.comp",
          "match": "\\*\\*"
        },
        {
          "name": "keyword.operator.arithmetic.comp",
          "match": "\\+\\-|\\+|\\-|\\*|/|%"
        }
      ]
    },
    "named-field-assignment": {
      "patterns": [
        {
          "comment": "Named field assignment like 'initial=value' or 'name=expr'",
          "match": "([\\w.-]+(?:\\?)?)\\s*(=\\*|=\\?|=)(?!=)",
          "captures": {
            "1": {
              "name": "variable.parameter.comp"
            },
            "2": {
              "name": "keyword.control.assignment.comp"
            }
          }
        }
      ]
    },
    "blocks": {
      "patterns": [
        {
          "comment": "Block with shape signature :args~shape (body) - parse signature as shape",
          "name": "meta.block.with-signature.comp",
          "begin": "(:)([^{(\\[]+)(\\()",
          "end": "\\)",
          "beginCaptures": {
            "1": {
              "name": "punctuation.section.block.begin.comp"
            },
            "2": {
              "patterns": [
                {
                  "include": "#shape-contents"
                }
              ]
            },
            "3": {
              "name": "punctuation.section.block.begin.comp"
            }
          },
          "endCaptures": {
            "0": {
              "name": "punctuation.section.block.end.comp"
            }
          },
          "patterns": [
            {
              "include": "#block-frontmatter"
            },
            {
              "include": "$self"
            }
          ]
        },
        {
          "comment": "Block with shape signature :args~shape {body} - parse signature as shape",
          "name": "meta.block.with-signature.comp",
          "begin": "(:)([^{(\\[]+)(\\{)",
          "end": "\\}",
          "beginCaptures": {
            "1": {
              "name": "punctuation.section.block.begin.comp"
            },
            "2": {
              "patterns": [
                {
                  "include": "#shape-contents"
                }
              ]
            },
            "3": {
              "name": "punctuation.section.block.begin.comp"
            }
          },
          "endCaptures": {
            "0": {
              "name": "punctuation.section.block.end.comp"
            }
          },
          "patterns": [
            {
              "include": "#block-frontmatter"
            },
            {
              "include": "$self"
            }
          ]
        },
        {
          "name": "meta.block.statement.comp",
          "begin": ":\\(",
          "end": "\\)",
          "beginCaptures": {
            "0": {
              "name": "punctuation.section.block.begin.comp"
            }
          },
          "endCaptures": {
            "0": {
              "name": "punctuation.section.block.end.comp"
            }
          },
          "patterns": [
            {
              "include": "#block-frontmatter"
            },
            {
              "include": "$self"
            }
          ]
        },
        {
          "name": "meta.block.struct.comp",
          "begin": ":\\{",
          "end": "\\}",
          "beginCaptures": {
            "0": {
              "name": "punctuation.section.block.begin.comp"
            }
          },
          "endCaptures": {
            "0": {
              "name": "punctuation.section.block.end.comp"
            }
          },
          "patterns": [
            {
              "include": "#block-frontmatter"
            },
            {
              "include": "$self"
            }
          ]
        },
        {
          "name": "meta.block.literal.comp",
          "begin": ":\\[",
          "end": "\\]",
          "beginCaptures": {
            "0": {
              "name": "punctuation.section.block.begin.comp"
            }
          },
          "endCaptures": {
            "0": {
              "name": "punctuation.section.block.end.comp"
            }
          },
          "patterns": [
            {
              "include": "#block-frontmatter"
            },
            {
              "include": "$self"
            }
          ]
        },
        {
          "comment": "Generic struct with frontmatter - matches any { } with documentation",
          "name": "meta.struct.comp",
          "begin": "\\{",
          "end": "\\}",
          "patterns": [
            {
              "include": "#block-frontmatter"
            },
            {
              "include": "$self"
            }
          ]
        },
        {
          "comment": "Generic paren group with frontmatter - matches any ( ) with documentation",
          "name": "meta.group.comp",
          "begin": "\\(",
          "end": "\\)",
          "patterns": [
            {
              "include": "#block-frontmatter"
            },
            {
              "include": "$self"
            }
          ]
        }
      ]
    }
  },
  "scopeName": "source.comp"
}