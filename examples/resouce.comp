!handle %readfile

!shape FileData& = {
    fd ~number
    path ~string
    mode ~string
}

!require read
!func open_for_read ~{path ~string} = {
    $fd = {path mode="r"} -> :syscall/open
    $fd -> !resource %readfile {
        release = [$fd -> :syscall/close]
    }
    & = {$fd path "r"} ~FileData
}

!require read
!func read_line ~{handle %readfile} = {
    handle&.fd -> :syscall/read_line
}
